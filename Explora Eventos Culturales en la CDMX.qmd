---
title: "Explora Eventos Culturales en la CDMX"
format:
  html:
    resources: 
      - shinylive-sw.js
filters:
  - shinylive

execute:
  echo: false
  message: false
  warning: false
  cache: false
---

## Static Version

```{r reactable}
library(duckdb)
library(dbplyr)
library(dplyr)
library(janitor)
library(R.utils) # for gunzip
library(reactable)
library(htmltools)
library(fontawesome)

# Raw URL of gzip-compressed parquet on GitHub
raw_gz_url <- "https://raw.githubusercontent.com/dar4datascience/AWS-SAM-Cultura-CDMX/main/data/scraped_data_cultura_cartelera_cdmx.parquet"

# Download gzip file
tmp_gz <- tempfile(fileext = ".parquet.gz")
download.file(raw_gz_url, tmp_gz, mode = "wb")

# Decompress gzip to Parquet
tmp_parquet <- tempfile(fileext = ".parquet")
R.utils::gunzip(tmp_gz, destname = tmp_parquet, overwrite = TRUE)

# Read Parquet into a tibble

library(duckdb)
library(dbplyr)
con <- dbConnect(duckdb())

# Read Parquet into a tibble
cartelera_cultural_cdmx <- tbl(con, tmp_parquet) |>
  collect() |>
  janitor::clean_names()

saveRDS(cartelera_cultural_cdmx, "cartelera_cultura_cdmx.RData")
# Now you can use dplyr and reactable
```

```{r createtable}
library(reactable)
library(reactablefmtr)
library(dplyr)
library(purrr)

# Prepare the dataframe for reactable
df_reactable <- cartelera_cultural_cdmx |>
  mutate(
    # Collapse list columns into single strings
    info_text = map_chr(info, ~ paste(.x, collapse = "<br>")),
    descripcion = map_chr(description, ~ glue::glue_collapse(.x, sep = " ")),
    fecha = schedule |> pull(date)
  ) |>
  distinct(
    banner_url,
    evento,
    recinto,
    fecha,
    info_text,
    location,
    detail_url,
    descripcion
  )


tagList(
  tags$button(
    class = "btn btn-primary",
    onclick = "Reactable.downloadDataCSV('tbl-cultura-manual')",
    tagList(
      fontawesome::fa("download"),
      "Descargar Todo"
    )
  )
)
```


```{r}
#| column: page
#| viewerHeight: 600
reactable(
  df_reactable,
  fullWidth = TRUE,
  style = list(width = "100%", height = "100vh"),
  wrap = TRUE,
  theme = cyborg(centered = TRUE),
  selection = "multiple",
  onClick = "select",
  striped = TRUE,
  pagination = TRUE,
  searchable = TRUE,
  defaultColDef = colDef(align = "center"),
  # details = function(index) {
  #   desc <- df_reactable$descripcion[index]
  #   desc_html <- gsub("\n", "<br>", desc) # Convert newlines to <br>
  #   htmltools::div(
  #     htmltools::tags$strong("Descripci√≥n del evento:"),
  #     htmltools::tags$br(),
  #     htmltools::tags$span(HTML(desc_html))
  #   )
  # },
  columns = list(
    banner_url = colDef(
      name = "Poster",
      maxWidth = 200,
      html = TRUE,
      cell = function(value, index) {
        url <- df_reactable$detail_url[index]
        if (!is.na(value) && nzchar(value)) {
          sprintf(
            '<a href="%s" target="_blank"><img src="%s" height="200" width="235"></a>',
            url, value
          )
        } else {
          ""
        }
      }
    ),
    evento = colDef(
      name = "Evento",
      minWidth = 200
    ),
    fecha = colDef(
      name = "Fecha"
    ),
    recinto = colDef(
      name = "Recinto",
      minWidth = 200
    ),
    info_text = colDef(
      name = "Info",
      minWidth = 200,
      html = TRUE # allow <br> line breaks
    ),
    location = colDef(
      name = "Location",
      minWidth = 200
    ),
    detail_url = colDef(
      name = "Detail Url",
      minWidth = 200,
      html = TRUE,
      cell = function(value) {
        if (!is.na(value) && nzchar(value)) {
          sprintf('<a href="%s" target="_blank">Ver Detalles</a>', value)
        } else {
          ""
        }
      }
    ),
    descripcion = colDef(
      name = "Descripcion",
      html = FALSE
    )
  ),
  elementId = "tbl-cultura-manual"
)
```

