AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Lambda with Playwright in a Docker container and Step Functions orchestration
Resources:
  CulturaPageCheck:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      Timeout: 15
      MemorySize: 1536
      EphemeralStorage:
        Size: 1024
      Architectures:
      - x86_64
      Role:
        Fn::GetAtt:
        - CulturaPageCheckRole
        - Arn
      ImageUri: culturapagecheck:playwright-pagecheck-v1
    Tags:
      Project: Cultura
      Environment: Dev
      Type: SingleRun
    Metadata:
      DockerContext: /home/rotundchonk/Documents/Github Repos/AWS-SAM-Cultura-CDMX/cultura-cdmx-sam/cultura_check_page
      DockerTag: playwright-pagecheck-v1
      Dockerfile: Dockerfile
      SamResourceId: CulturaPageCheck
  CulturaPageCheckRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  PlaywrightCardScrapper:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      Timeout: 60
      MemorySize: 3008
      EphemeralStorage:
        Size: 1024
      Architectures:
      - x86_64
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: CulturaBucket
      Role:
        Fn::GetAtt:
        - PlaywrightCardScrapperRole
        - Arn
      ImageUri: playwrightcardscrapper:playwright-card-scraper-v1
    Tags:
      Project: Cultura
      Environment: Dev
      Type: MultiRun
    Metadata:
      DockerContext: /home/rotundchonk/Documents/Github Repos/AWS-SAM-Cultura-CDMX/cultura-cdmx-sam/playwright_card_scrape
      DockerTag: playwright-card-scraper-v1
      Dockerfile: Dockerfile
      SamResourceId: PlaywrightCardScrapper
    ProvisionedConcurrencyConfig:
      ProvisionedConcurrentExecutions: 2
  PlaywrightCardScrapperRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
      - PolicyName: S3WriteAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:PutObject
            - s3:PutObjectAcl
            Resource:
              Fn::Sub: ${CulturaBucket.Arn}/*
  CulturaBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-${AWS::Region}-${AWS::AccountId}
      LifecycleConfiguration:
        Rules:
        - Id: ExpireOldObjects
          Status: Enabled
          ExpirationInDays: 30
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  CulturaScrapeStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      RoleArn:
        Fn::GetAtt:
        - CulturaStateMachineRole
        - Arn
      DefinitionString:
        Fn::Sub: "{\n  \"Comment\": \"Scrape all pages in parallel using Lambda Map\"\
          ,\n  \"StartAt\": \"GetPageNumbers\",\n  \"States\": {\n    \"GetPageNumbers\"\
          : {\n      \"Type\": \"Task\",\n      \"Resource\": \"${CulturaPageCheck.Arn}\"\
          ,\n      \"ResultPath\": \"$.pages\",\n      \"Next\": \"ScrapePagesMap\"\
          \n    },\n    \"ScrapePagesMap\": {\n      \"Type\": \"Map\",\n      \"\
          ItemsPath\": \"$.pages.body.page_numbers\",\n      \"MaxConcurrency\": 20,\n\
          \      \"Iterator\": {\n        \"StartAt\": \"ScrapeSinglePage\",\n   \
          \     \"States\": {\n          \"ScrapeSinglePage\": {\n            \"Type\"\
          : \"Task\",\n            \"Resource\": \"${PlaywrightCardScrapper.Arn}\"\
          ,\n            \"End\": true\n          }\n        }\n      },\n      \"\
          End\": true\n    }\n  }\n}\n"
  CulturaStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: states.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AWSStepFunctionsFullAccess
      Policies:
      - PolicyName: LambdaInvoke
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - lambda:InvokeFunction
            Resource:
            - Fn::GetAtt:
              - CulturaPageCheck
              - Arn
            - Fn::GetAtt:
              - PlaywrightCardScrapper
              - Arn
  CulturaScrapeScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: CulturaScrapeDailyRule
      ScheduleExpression: cron(0 12 * * ? *)
      State: ENABLED
      Targets:
      - Arn:
          Ref: CulturaScrapeStateMachine
        Id: CulturaScrapeStateMachineTarget
        RoleArn:
          Fn::GetAtt:
          - EventBridgeInvokeStepFnRole
          - Arn
  EventBridgeInvokeStepFnRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: AllowStartExecution
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - states:StartExecution
            Resource:
              Ref: CulturaScrapeStateMachine
